*THIS HAS BEEN DONE AND FILES ARE NOW IN TEL LIBRARY--USED TO IMPORT MISSING DATA;
DATA COSTATS;
	SET 'Y:\Dropbox\Data\costat12';
RUN;
DATA AGE;
	SET 'Y:\Dropbox\Data\AGE02';
RUN;

DATA COSTATCOMPLETE;
	MERGE COSTATS AGE;
	BY STCOU;
RUN;


DATA DEMOGRAPHIC;
	SET COSTATCOMPLETE;
 		KEEP STCOU AREANAME AGE290202D AGE290207D AGE770202D AGE770207D BZA110202D BZA110207D BZN230202D BZN230207D BZN430202D BZN430207D BZN630202D BZN630207D 
 			BZN675202D BZN675207D BZN695202D BZN695207D BZN830202D BZN830207D BZN870202D BZN870207D EDU300200D EDU314200D EDU334200D EDU354200D EDU374200D EDU404209D
 			EDU410209D EDU416209D EDU422209D EDU428209D EDU434209D EDU452209D EDU458209D EDU464209D EDU470209D EDU476209D EDU482209D HSD310200D HSD310209D HSG050200D
 			HSG050209D HSG170200D HSG170209D LND010200D LOG020197D LOG020202D PEN020202D PEN020207D PVY410200D PVY410209D PVY420199D PVY420209D SPR010202D SPR010207D
 			SPR030202D SPR030207D;
RUN;

DATA DEMOGRAPHIC;
	SET DEMOGRAPHIC;
		RENAME LOG020202D=RESPOP02 	HSD310200D=PERS_HLD02 	HSD310209D=PERS_HLD07 	PEN020202D=PCINC02	PEN020207D=PCINC07;
RUN;
*WILL NEED TO CALCULATE COMPOUND GROWTH FOR RESPOP07
WILL ALSO NEED TO CALCULATE RESPOP(2) FOR BOTH 02 AND 07
CREATE DENSITY07 THAT IS THE SAME AS DENSITY 02
CALCULATE POPULATION GROWTH;

DATA DEMOGRAPHIC;
	SET DEMOGRAPHIC;
*CALCULATE POPULATION GROWTH RATE TO FORECAST 2007 DATA POINT;
	DENSITY02=(RESPOP02/LND010200D);
	POPGROWTH=((RESPOP02/LOG020197D)**(1/5))-1;
	RESPOP03 = (POPGROWTH*RESPOP02)+RESPOP02;
	RESPOP04 = (POPGROWTH*RESPOP03)+RESPOP03;
	RESPOP05 = (POPGROWTH*RESPOP04)+RESPOP04;
	RESPOP06 = (POPGROWTH*RESPOP05)+RESPOP05;
	RESPOP07 = (POPGROWTH*RESPOP06)+RESPOP06;
	DROP RESPOP03 RESPOP04 RESPOP05 RESPOP06 POPGROWTH;
	DENSITY07=RESPOP07/LND010200D;
	PYOUNG02=AGE290202D/RESPOP02;
	PYOUNG07=AGE290207D/RESPOP07;
	POP6502=AGE770202D/RESPOP02;
	POP6507=AGE770207D/RESPOP07;
	RESPOP202=RESPOP02**2;
	RESPOP207=RESPOP07**2;
	PRE194002=HSG170200D/HSG050200D;
	PRE194007=HSG170209D/HSG050209D;
	PVT_SCH02=(EDU314200D+EDU334200D+EDU354200D+EDU374200D)/EDU300200D;
		*IN 2009 DATA WAS DIVIDED INTO MALE AND FEMALE, THIS IS WHY 2009 HAS TWICE AS MANY VARIABLES;
	PVT_SCH07=(EDU410209D+EDU458209D+EDU416209D+EDU464209D+EDU422209D+EDU470209D+EDU428209D+EDU476209D+EDU434209D+EDU482209D)/(EDU404209D+EDU470209D); *I'd wager its supposed to be EDU404209D and >EDU452209D< in the denominator
	POVERTY02=PVY420199D/PVY410200D;
	POVERTY07=PVY420209D/PVY410209D;
	PC_SSCI02=SPR030202D/SPR010202D;
	PC_SSCI07=SPR030207D/SPR010207D;
		*ASK ABOUT DIVERSITY;
	DIVERSITY02=PCINC02/POVERTY02;
	DIVERSITY07=PCINC07/POVERTY07;
	EMP_RESI02=BZA110202D/RESPOP02;
	EMP_RESI07=BZA110207D/RESPOP07;
	MANU_RESI02=BZN230202D/RESPOP02;
	MANU_RESI07=BZN230207D/RESPOP07;
	RETL_RES02=BZN430202D/RESPOP02;
	RETL_RES07=BZN430207D/RESPOP07;
	SERV_RES02=(BZN630202D+BZN675202D+BZN695202D+BZN830202D+BZN870202D)/RESPOP02;
	SERV_RES07=(BZN630207D+BZN675207D+BZN695207D+BZN830207D+BZN870207D)/RESPOP07;
	POPGROWTH02=((RESPOP02/LOG020197D)**(1/5))-1;
	POPGROWTH07=((RESPOP07/RESPOP02)**(1/5))-1;
	drop AGE290202D AGE290207D AGE770202D AGE770207D BZA110202D BZA110207D BZN230202D BZN230207D BZN430202D BZN430207D BZN630202D BZN630207D BZN675202D BZN675207D BZN695202D BZN695207D BZN830202D BZN830207D BZN870202D BZN870207D EDU314200D EDU334200D EDU354200D EDU374200D EDU300200D EDU410209D EDU458209D EDU416209D EDU422209D EDU470209D EDU428209D EDU476209D EDU434209D EDU452209D EDU464209D EDU482209D EDU404209D EDU470209D HSG050200D HSG050209D HSG170200D HSG170209D PVY420199D PVY420209D PVY410200D PVY410209D SPR010202D SPR010207D SPR030202D SPR030207D LOG020197D LND010200D;
RUN;

/*GENERALLY, YOU SHOULD USE SEPERATE STATE AND COUNTY VARIABLES, NOT STATCOUNTY*/	
**Import zipcode to provide MSA;
DATA zipcode;
	SET sashelp.zipcode;
	drop AREACODE AREACODES TIMEZONE GMTOFFSET ALIAS_CITY ALIAS_CITYN ZIP_CLASS DST PONAME;
	LENGTH STATE 3; LENGTH COUNTY 3;*CHANGES LENGTH OF VARIABLES FROM 8 TO 3, THIS IS MINIMUM FOR A NUMBER;

	NCOUNTY = PUT(COUNTY,3.);*CHANGE COUNTY TO CHARACTER INSTEAD OF NUMBER;        /***better way to do this is to use shift right shift left, trim functions***/
	LENGTH NCOUNTY $3;*ADDS ZEROS IN FRONT OF DIGITS TO ENSURE ALL HAVE 3 NUMBERS; /** changing length of variable causes problems, for numeric length is not  */
	IF LENGTH (COMPRESS(NCOUNTY)) = 1 THEN NCOUNTY = COMPRESS('00'||NCOUNTY);      /*  the number of cels.  All variable with the same name must have the same */
	IF LENGTH (COMPRESS(NCOUNTY)) = 2 THEN NCOUNTY = COMPRESS('0'||NCOUNTY);       /*  length or they cannot be merged **/ 
	IF LENGTH (COMPRESS(NCOUNTY)) = 3 THEN NCOUNTY = COMPRESS (NCOUNTY);

	NSTATE = PUT (STATE,2.);
	LENGTH NSTATE $2;
	IF LENGTH (COMPRESS(NSTATE)) = 1 THEN NSTATE = COMPRESS('0'||NSTATE);
	IF LENGTH (COMPRESS(NCOUNTY)) = 2 THEN NCOUNTY = COMPRESS (NCOUNTY);

	LENGTH STCOU $5;
	CALL CATT(STCOU, NSTATE, NCOUNTY);
	PROC SORT DATA=ZIPCODE;
	BY STCOU;

RUN;
*This is need to remove/prevent duplicate counties due to multiple cities in each county;
	proc sort data=zipcode out=temp;
	by STCOU;
	run;
	data uniquemsa;
	set temp;
	by STCOU;
	if not first.stcou and last.stcou; /*ISN'T THIS ONLY SELECTING ONE OBSERVATION COUNTIES?*/
	RUN;

DATA ZIPCODE; /* msa CODES ARE ALREADY IN THE DATA SET */
	SET uniquemsa;
	KEEP STCOU MSA;
RUN;

DATA FINALDEMO;
	MERGE DEMOGRAPHIC ZIPCODE;
	BY STCOU;

RUN;

DATA FINALDEMO;
	SET FINALDEMO;
	RETAIN MSA STCOU Areaname POP6502 POP6507 POVERTY02 POVERTY07 PRE194002 PRE194007 PVT_SCH02 PVT_SCH07 PYOUNG02 PYOUNG07 RESPOP02 RESPOP07 RESPOP202 RESPOP207 RETL_RES02 RETL_RES07 SERV_RES02 SERV_RES07 DENSITY02 DENSITY07 DIVERSITY02 DIVERSITY07 EMP_RESI02 EMP_RESI07 MANU_RESI02 MANU_RESI07 PCINC02 PCINC07 PC_SSCI02 PC_SSCI07 PERS_HLD02 PERS_HLD07 POPGROWTH02 POPGROWTH07;
RUN;
	
*File sent to Mike, changes from wide to long and validated data;
*Mike returned file: final_chad.dta..  This file has been changed to a SAS file and added to the library as DEMOGRAPH, copy saved in dropbox;

DATA TEL.DEMOGRAPH;
	SET 'Y:\Dropbox\Data\DEMOGRAPH';
RUN;

*IMPORT MARVIN'S DATA AND LABEL GOVFIN;
DATA TEL.GOVFIN;
	SET 'W:\PublicFinance\Data\Government Finances\MWSETS\CO_GOVFIN0207';
		KEEP govname GDTYPE survyr FIPST_N FIPSCO_N
		ALCBEVTX BONDFD BORTOT CAMGR CCAIRPTS CCED CCHAUR CCHEC CCHGYS CCHOSP CCINT CCLSC CCMCACT CCOLSC CCOTAUN CCOTEDU CCOTHER
		CCPAREC CCPF CCSEW CCSLC CCSOPROP CCSOTSEW CCSPECA CCWTAT CORINCTX DGEXP DGEXPAS DGEXPCN DGEXPCO DGEXPCOP DGEXPCPO DGEXPINT
		DGEXPLSE EDHE EDLB EDLS EDNEC EDTOT EHCO EHHUR EHNR EHPAR EHSEW EMPRETOW EMPRETRV EMPRTEXP ERINTREV EXHIBIT FFCGENDT FFCOUT
		FFCUTDT FIPSCO_N FIPST_N GAGPB GDO GENREV GRFOS GSAGR HEALTH HPOWN IGEXP INCTX INGOVRE INGOVRF INGOVRFO INGOVRS INTDEBT LANDAREA
		LTDFCIS LTDFCRET LTDNGIS LTDNGRET LTDO LTDREDT LTGDFCIS LTGDFCRT LTGDNGIS LTGDNGRT LTGDRET LTUDFCIS LTUDFCRT LTUDNGIS LTUDNGRT
		LTUDRET LUSPDRT MOTFLTX MOTVEHTX NGGENDT NGUOUT NGUTDT OTHER OTHERTX OTHTX PROPERTY PSCORR PSFIRE PSPOL PUTILTX PWELT RETEARN
		RETOTHR SINKFD SSAGR STDO STDR TAXES TAX_REV TCC TINGOVR TOBPDTX TOTEXP TOTGE TOTGR TOTIGR TOTINCTX TOTREV TRAPTS TRHGWY
		TRPF TRWTAT UTILDT UTILREV;
	RUN;
*126 VARIABLES KEPT, IS THIS CORRECT?;

*CREATE STCOU FOR MERGER;
DATA TEL.GOVFIN;
SET TEL.GOVFIN;
NCOUNTY = PUT(FIPSCO_N,3.);*CHANGE COUNTY TO CHARACTER INSTEAD OF NUMBER;         /*IT IS BETTER TO CHANGE YOURS TO NUMERIC, fipsco_n IS NUMERIC*/
	LENGTH NCOUNTY $3;*ADDS ZEROS IN FRONT OF DIGITS TO ENSURE ALL HAVE 3 NUMBERS;  /* THE MERGE WILL NOT WORK FOR EFFECT97 IS YOU DO THIS*/
	IF LENGTH (COMPRESS(NCOUNTY)) = 1 THEN NCOUNTY = COMPRESS('00'||NCOUNTY);
	IF LENGTH (COMPRESS(NCOUNTY)) = 2 THEN NCOUNTY = COMPRESS('0'||NCOUNTY);
	IF LENGTH (COMPRESS(NCOUNTY)) = 3 THEN NCOUNTY = COMPRESS (NCOUNTY);

	NSTATE = PUT (FIPST_N,2.);
	LENGTH NSTATE $2;
	IF LENGTH (COMPRESS(NSTATE)) = 1 THEN NSTATE = COMPRESS('0'||NSTATE);
	IF LENGTH (COMPRESS(NCOUNTY)) = 2 THEN NCOUNTY = COMPRESS (NCOUNTY);  /** ?????? */

	LENGTH STCOU $5;
	CALL CATT(STCOU, NSTATE, NCOUNTY);
RUN;

DATA TEL.GOVFIN;
SET TEL.GOVFIN;
	YEAR= .;
	IF (SURVYR=02) THEN YEAR=2002; /*MAKE SURE THS VARIABLE IS CORRECT ... SURVEYR ... 02 and 07 are census years*/
	IF (SURVYR=07) THEN YEAR=2007;
RUN;

*Now to merge data where stcou and year are the same;

PROC SORT DATA=TEL.GOVFIN; BY STCOU YEAR; RUN;
PROC SORT DATA=TEL.DEMOGRAPH; BY STCOU YEAR; RUN;

DATA TEL.UPDATED;                
	MERGE TEL.DEMOGRAPH TEL.GOVFIN;
	BY STCOU YEAR;
RUN;

/** I DON'T SEE WHERE YOU HAVE SELECTED OUT THE DEMOGRAPHIC VARIABLES BY YEAR AND THEN RENAMNED THEM TO THE SAME NAME. 
 i.e., POVERTY02 AND POVERTY 07 MUST BE EACH NAMED POVERTY **? 